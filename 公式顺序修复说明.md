# LaTeX公式顺序混乱问题修复说明

## 问题概述

在MD2Word导出过程中，LaTeX公式的顺序可能出现混乱，导致导出的Word文档中公式显示顺序与原始Markdown文档不一致。

## 问题根本原因

通过分析日志和代码，发现问题的根本原因在于：

### 1. 后处理阶段的替换顺序不一致
- **原问题**: 在`exportService.js`的`postProcessDocx`函数中，OMML占位符的替换顺序是按照`currentExportOmmlResults`数组的存储顺序进行的
- **影响**: 这个顺序可能与XML文档中占位符的实际出现顺序不匹配，导致公式顺序混乱

### 2. Markdown替换阶段的处理逻辑
- **原问题**: 虽然使用了倒序处理避免索引错乱，但日志输出和处理逻辑可能造成混淆
- **影响**: 使得问题难以追踪和调试

## 修复方案

### 1. 修复后处理阶段的替换顺序（主要修复）

**文件**: `src/services/exportService.js`

**修改位置**: `postProcessDocx` 函数中的OMML占位符替换逻辑

**修复内容**:
```javascript
// 旧代码：直接按数组顺序处理
for (const ommlResult of currentExportOmmlResults) {
  // ... 处理逻辑
}

// 新代码：按XML中占位符的实际出现顺序处理
// 1. 提取XML中所有占位符的ID及其位置
const placeholdersInXmlOrder = [];
const placeholderRegex = /<!--OMML_PLACEHOLDER_([^-]+)-->|&lt;!--OMML_PLACEHOLDER_([^-]+)--&gt;/g;
let match;

while ((match = placeholderRegex.exec(xmlString)) !== null) {
  const id = match[1] || match[2];
  const position = match.index;
  const placeholder = match[0];
  placeholdersInXmlOrder.push({ id, position, placeholder });
}

// 2. 按位置排序，确保按照在XML中的实际顺序进行替换
placeholdersInXmlOrder.sort((a, b) => a.position - b.position);

// 3. 创建ID到OMML结果的映射，按XML顺序处理
const ommlResultMap = new Map();
currentExportOmmlResults.forEach(result => {
  ommlResultMap.set(result.id, result);
});

for (const placeholderInfo of placeholdersInXmlOrder) {
  const ommlResult = ommlResultMap.get(placeholderInfo.id);
  // ... 处理逻辑使用placeholderInfo.placeholder
}
```

**关键改进**:
- 从XML中提取占位符的实际出现顺序
- 按照这个顺序进行OMML替换
- 使用实际在XML中找到的占位符格式（原始或转义）
- 添加详细的调试日志

### 2. 改进Markdown替换阶段的日志和逻辑（辅助修复）

**文件**: `src/services/latexExportService.js`

**修改位置**: `replaceLatexInMarkdown` 函数

**修复内容**:
```javascript
// 改进日志输出，清楚显示原始顺序和执行顺序
console.log(`[LaTeX Export] 公式替换顺序 (执行顺序，倒序):`, sortedReplacements.map(r => r.formulaId));
console.log(`[LaTeX Export] 公式替换顺序 (文档中的原始顺序):`, replacements.map(r => r.formulaId));
```

**关键改进**:
- 添加更清晰的日志输出
- 明确区分执行顺序和文档原始顺序
- 便于调试和问题追踪

## 修复效果

### 预期改进

1. **公式顺序正确**: 导出的Word文档中公式顺序将与原始Markdown文档完全一致
2. **更好的调试信息**: 增加的日志信息将帮助快速定位任何潜在问题
3. **更稳定的替换过程**: 基于XML实际内容的替换更加可靠

### 日志改进

修复后的日志将显示：
```
[OMML Post-process Debug] XML中占位符顺序: ["formula_1@position1", "formula_2@position2", ...]
[OMML Post-process Debug] 处理OMML结果: {id: "formula_1", xmlPosition: position1, ...}
[LaTeX Export] 公式替换顺序 (执行顺序，倒序): ["formula_29", "formula_28", ...]
[LaTeX Export] 公式替换顺序 (文档中的原始顺序): ["formula_1", "formula_2", ...]
```

## 测试建议

1. **使用测试文档**: 使用提供的`test-formula-order.md`文件进行测试
2. **检查导出结果**: 验证Word文档中公式顺序是否与Markdown一致
3. **观察日志**: 查看控制台中的调试信息，确认处理顺序正确

## 向后兼容性

- 所有修改都是向后兼容的
- 不会影响现有功能
- 仅改进了公式处理的稳定性和准确性

## 总结

这次修复主要解决了OMML占位符替换顺序的问题，确保公式在最终文档中的顺序与原始Markdown文档一致。通过在XML文档中按实际占位符出现顺序进行替换，而不是按照内存中数组的存储顺序，根本性地解决了公式顺序混乱的问题。
