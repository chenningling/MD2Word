# LaTeX公式顺序问题调试指南

## 修复状态

✅ **已完成的修复**：
1. 修改了`src/services/exportService.js`中的后处理逻辑，按XML中占位符的实际顺序进行替换
2. 增加了详细的调试日志，可以追踪整个替换过程
3. 添加了公式内容验证机制

## 调试步骤

### 1. 清除缓存（重要！）

如果修复没有生效，首先执行以下步骤清除缓存：

```javascript
// 在浏览器控制台中执行
import { clearLatexExportCache } from './src/services/latexExportService.js';
clearLatexExportCache();

// 或者刷新页面强制重新加载
location.reload(true);
```

### 2. 使用测试文档

使用以下测试文档验证公式顺序：

```markdown
# 公式顺序测试

## 第一部分：简单公式
$$a + b = c$$

$$x \\cdot y = z$$

## 第二部分：复杂公式
$$\\frac{a + b}{c + d} = \\frac{x}{y}$$

$$\\sqrt{x^2 + y^2} = r$$

## 第三部分：特殊公式
$$e^{i\\pi} + 1 = 0$$

$$\\int_0^{\\infty} e^{-x^2} dx = \\frac{\\sqrt{\\pi}}{2}$$
```

### 3. 查看调试日志

导出Word文档时，注意观察控制台中的以下关键日志：

#### 3.1 公式提取阶段
```
[LaTeX Utils] 发现公式 {id: 'formula_1', type: 'block', latex: 'a + b = c', ...}
[LaTeX Utils] 发现公式 {id: 'formula_2', type: 'block', latex: 'x \\cdot y = z', ...}
```
**检查**：公式ID是否按文档顺序递增？

#### 3.2 Markdown替换阶段
```
[LaTeX Export] 准备替换公式: a + b = c → <!--OMML_PLACEHOLDER_formula_1-->
[LaTeX Export] 准备替换公式: x \cdot y = z → <!--OMML_PLACEHOLDER_formula_2-->
```
**检查**：占位符ID是否与公式内容匹配？

#### 3.3 XML占位符顺序检查
```
[OMML Post-process Debug] XML中占位符顺序: (6) ['formula_1@8443', 'formula_2@9628', ...]
```
**检查**：占位符在XML中的位置（@后面的数字）是否递增？

#### 3.4 OMML替换过程
```
[OMML Post-process Debug] 处理OMML结果: {id: 'formula_1', ...}
[OMML Post-process Debug] ✅ 占位符 <!--OMML_PLACEHOLDER_formula_1--> 替换成功
```
**检查**：是否所有占位符都成功替换？

#### 3.5 最终验证
```
[OMML Post-process Debug] 处理完成，剩余占位符: 0 []
[OMML Post-process Debug] 最终XML中包含 6 个数学公式
[OMML Post-process Debug] 公式 1: <m:oMath ...><m:r><m:t>a+b=c</m:t>...
[OMML Post-process Debug] 公式 2: <m:oMath ...><m:r><m:t>x⋅y=z</m:t>...
```
**检查**：最终公式顺序是否正确？

### 4. 如果问题仍然存在

如果按照以上步骤检查后问题仍然存在，请提供以下信息：

1. **完整的控制台日志**（特别是上述关键部分）
2. **使用的测试Markdown文档内容**
3. **导出的Word文档中实际显示的公式顺序**
4. **浏览器和操作系统信息**

### 5. 可能的其他问题

#### 5.1 特定公式类型问题
某些复杂公式（如矩阵、多行公式）可能有特殊处理逻辑，检查日志中是否有特定错误。

#### 5.2 Word软件版本问题
不同版本的Word可能对OMML的解析略有不同，如果可能，尝试在不同的Word版本中打开文档。

#### 5.3 字体和编码问题
确保系统中安装了数学字体，如"Cambria Math"等。

## 额外的调试工具

### 手动触发缓存清除
```javascript
// 在控制台中执行
clearLatexExportCache();
console.log('缓存已清除，请重新导出文档');
```

### 查看当前缓存状态
```javascript
// 在控制台中执行
import { getLatexExportStats } from './src/services/latexExportService.js';
console.log('当前导出统计:', getLatexExportStats());
```

## 联系支持

如果问题仍然无法解决，请将以上调试信息整理后提供详细反馈。
